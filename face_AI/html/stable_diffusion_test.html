<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thử Nghiệm Stable Diffusion - Gương Soi Tương Lai</title>
    <link rel="stylesheet" href="../css/custom.css">
    <link rel="stylesheet" href="../css/future_mirror.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4DD0E1;
            --primary-dark: #26C6DA;
            --secondary-color: #B2EBF2;
            --accent-color: #00ACC1;
            --text-dark: #263238;
            --text-light: #546E7A;
            --background-light: #F0FDFF;
            --card-shadow: 0 8px 32px rgba(77, 208, 225, 0.15);
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background-light);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: var(--text-dark);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(77, 208, 225, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(178, 235, 242, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(77, 208, 225, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            gap: 24px;
            grid-template-columns: 1fr;
        }
        
        .test-header {
            text-align: center;
            padding: 40px 30px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
        }

        .test-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-color);
        }
        
        .test-header h1 {
            color: var(--text-dark);
            margin: 0 0 16px 0;
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .test-header p {
            color: var(--text-light);
            font-size: 1.1rem;
            margin: 0;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .test-steps {
            display: grid;
            gap: 20px;
        }
        
        .test-step {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(77, 208, 225, 0.1);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .test-step::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary-color);
            transform: scaleX(0);
            transition: var(--transition);
        }

        .test-step:hover::before {
            transform: scaleX(1);
        }

        .test-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(77, 208, 225, 0.2);
        }
        
        .test-step h3 {
            margin: 0 0 20px 0;
            color: var(--text-dark);
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .test-step h3 i {
            color: var(--primary-color);
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }
        
        .upload-container {
            padding: 40px 30px;
            border: 2px dashed var(--secondary-color);
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: var(--background-light);
            position: relative;
            overflow: hidden;
        }

        .upload-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(77, 208, 225, 0.05);
            transition: var(--transition);
        }
        
        .upload-container:hover::before {
            left: 0;
        }
        
        .upload-container:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(77, 208, 225, 0.15);
        }
        
        .upload-container i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 16px;
            display: block;
            transition: var(--transition);
        }

        .upload-container:hover i {
            transform: scale(1.1);
        }

        .upload-container p {
            color: var(--text-light);
            font-size: 1.1rem;
            margin: 0;
            font-weight: 500;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
        }
        
        .control-group select, 
        .control-group input[type="range"], 
        .control-group input[type="number"] {
            padding: 12px 16px;
            border: 2px solid var(--secondary-color);
            border-radius: 12px;
            font-size: 1rem;
            transition: var(--transition);
            background: white;
            color: var(--text-dark);
        }

        .control-group select:focus, 
        .control-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(77, 208, 225, 0.1);
        }

        .control-group input[type="range"] {
            -webkit-appearance: none;
            height: 8px;
            background: var(--secondary-color);
            border-radius: 4px;
            padding: 0;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
        }

        .control-group input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 0 8px rgba(77, 208, 225, 0.2);
        }
        
        .process-btn {
            display: block;
            width: 100%;
            padding: 16px 24px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(77, 208, 225, 0.3);
        }

        .process-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition);
        }

        .process-btn:hover::before {
            left: 100%;
        }
        
        .process-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(77, 208, 225, 0.4);
        }

        .process-btn:active {
            transform: translateY(0);
        }
        
        .process-btn:disabled {
            background: #B0BEC5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .process-btn:disabled::before {
            display: none;
        }
        
        .result-container {
            display: none;
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(77, 208, 225, 0.1);
        }

        .result-container h3 {
            color: var(--text-dark);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 30px 0;
            text-align: center;
            position: relative;
        }

        .result-container h3::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: var(--primary-color);
            border-radius: 2px;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .result-item {
            position: relative;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
            background: white;
        }

        .result-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }
        
        .result-label {
            position: absolute;
            top: 16px;
            left: 16px;
            padding: 8px 16px;
            background: rgba(77, 208, 225, 0.95);
            color: white;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            z-index: 2;
        }
        
        .result-image {
            width: 100%;
            display: block;
            transition: var(--transition);
        }

        .result-item:hover .result-image {
            transform: scale(1.02);
        }
        
        .api-key-container {
            margin-bottom: 20px;
            padding: 24px;
            background: var(--background-light);
            border-radius: var(--border-radius);
            border: 2px solid var(--secondary-color);
            transition: var(--transition);
        }

        .api-key-container:hover {
            border-color: var(--primary-color);
        }
        
        .api-key-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
        }
        
        .api-key-container input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--secondary-color);
            border-radius: 12px;
            margin-bottom: 16px;
            font-size: 1rem;
            transition: var(--transition);
            background: white;
            color: var(--text-dark);
        }

        .api-key-container input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(77, 208, 225, 0.1);
        }

        .api-key-container input::placeholder {
            color: var(--text-light);
        }
        
        .api-key-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .mt-2 {
            margin-top: 16px;
        }
        
        .ml-2 {
            margin-left: 12px;
        }

        .mt-4 {
            margin-top: 24px;
        }
        
        .btn {
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            border: none;
            transition: var(--transition);
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition);
        }

        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 15px rgba(77, 208, 225, 0.3);
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(77, 208, 225, 0.4);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(77, 208, 225, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }
        
        .status-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(77, 208, 225, 0.1);
            display: none;
            position: relative;
            overflow: hidden;
        }

        .status-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-color);
        }

        .status-container h3 {
            color: var(--text-dark);
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0 0 20px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .status-message {
            margin: 0 0 20px 0;
            color: var(--text-light);
            font-size: 1rem;
            font-weight: 500;
        }
        
        .loading-bar {
            height: 8px;
            background: var(--secondary-color);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }
        
        .loading-progress {
            height: 100%;
            background: var(--primary-color);
            border-radius: 20px;
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .loading-progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-image: linear-gradient(
                -45deg,
                rgba(255, 255, 255, 0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 50px 50px;
            animation: move 2s linear infinite;
        }

        @keyframes move {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 50px 50px;
            }
        }
        
        .effect-description {
            margin-top: 20px;
            padding: 24px;
            background: var(--background-light);
            border-radius: var(--border-radius);
            border-left: 6px solid var(--primary-color);
            position: relative;
            transition: var(--transition);
        }

        .effect-description::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 4px;
            background: var(--secondary-color);
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        .effect-description:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 15px rgba(77, 208, 225, 0.1);
        }
        
        .effect-description h4 {
            margin: 0 0 16px 0;
            color: var(--text-dark);
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .effect-description h4 i {
            color: var(--primary-color);
            font-size: 1.1em;
        }
        
        .effect-description p {
            margin: 12px 0;
            color: var(--text-light);
            line-height: 1.6;
        }

        .effect-description p:last-child {
            margin-bottom: 0;
        }
        
        .note {
            color: var(--text-light);
            font-size: 0.9em;
            font-style: italic;
            padding: 12px;
            background: rgba(77, 208, 225, 0.05);
            border-radius: 8px;
            border-left: 3px solid var(--accent-color);
            margin-top: 16px;
        }

        .note i {
            color: var(--accent-color);
            margin-right: 8px;
        }
        
        .cnn-report {
            margin: 24px 0;
            padding: 30px;
            background: white;
            border-radius: var(--border-radius);
            border-left: 6px solid var(--accent-color);
            box-shadow: var(--card-shadow);
            position: relative;
            transition: var(--transition);
        }

        .cnn-report::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 4px;
            background: var(--secondary-color);
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        .cnn-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 172, 193, 0.15);
        }
        
        .cnn-report h4 {
            margin: 0 0 20px 0;
            color: var(--text-dark);
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .cnn-report h4 i {
            color: var(--accent-color);
            font-size: 1.1em;
        }
        
        .report-summary {
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-dark);
            font-size: 1.1rem;
            padding: 16px;
            background: var(--background-light);
            border-radius: 12px;
            border-left: 4px solid var(--accent-color);
        }
        
        .report-details {
            margin-bottom: 20px;
        }
        
        .report-details ul {
            margin: 8px 0;
            padding-left: 24px;
        }
        
        .report-details li {
            margin: 8px 0;
            color: var(--text-light);
            line-height: 1.5;
        }
        
        .report-indicators {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .indicator-badge {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            background: var(--secondary-color);
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-dark);
            transition: var(--transition);
        }

        .indicator-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .indicator-badge.high {
            background: #FFEBEE;
            color: #C62828;
            border: 2px solid #FFCDD2;
        }
        
        .indicator-badge.medium {
            background: #FFF8E1;
            color: #F57F17;
            border: 2px solid #FFECB3;
        }
        
        .indicator-badge.low {
            background: #E8F5E8;
            color: #2E7D32;
            border: 2px solid #C8E6C9;
        }
        
        .spinner {
            border: 3px solid var(--secondary-color);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border-top-color: var(--primary-color);
            display: inline-block;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .test-step {
            animation: fadeIn 0.6s ease-out;
        }

        .test-step:nth-child(1) { animation-delay: 0.1s; }
        .test-step:nth-child(2) { animation-delay: 0.2s; }
        .test-step:nth-child(3) { animation-delay: 0.3s; }
        .test-step:nth-child(4) { animation-delay: 0.4s; }
        .test-step:nth-child(5) { animation-delay: 0.5s; }
        
        .gemini-processing {
            padding: 20px;
            margin-top: 20px;
            background: white;
            border-radius: var(--border-radius);
            border-left: 6px solid #6200ee;
            box-shadow: var(--card-shadow);
            display: none;
            animation: slideIn 0.5s ease-out;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .test-container {
                gap: 16px;
            }

            .test-header {
                padding: 30px 20px;
            }

            .test-header h1 {
                font-size: 2rem;
            }

            .test-step {
                padding: 20px;
            }

            .controls {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .result-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .api-key-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .test-header h1 {
                font-size: 1.5rem;
            }

            .test-header p {
                font-size: 1rem;
            }

            .test-step {
                padding: 16px;
            }

            .upload-container {
                padding: 30px 20px;
            }

            .process-btn {
                padding: 14px 20px;
                font-size: 1rem;
            }
        }

        /* Dark mode support (optional) */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
                color: #ffffff;
            }

            .test-step,
            .result-container,
            .status-container,
            .cnn-report {
                background: #2d2d2d;
                border-color: rgba(77, 208, 225, 0.3);
            }

            .upload-container,
            .api-key-container,
            .effect-description {
                background: #1a1a1a;
            }

            .control-group input,
            .control-group select,
            .api-key-container input {
                background: #2d2d2d;
                color: #ffffff;
                border-color: rgba(77, 208, 225, 0.3);
            }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>Thử Nghiệm Stable Diffusion</h1>
            <p>Công cụ này giúp kiểm tra tính năng sử dụng Stable Diffusion để mô phỏng tác động của ma túy, rượu bia và thuốc lá lên khuôn mặt.</p>
        </div>
        
        <div class="test-steps">
            <div class="test-step">
                <h3><i class="fas fa-key"></i> Bước 1: Nhập API Key (nếu có)</h3>
                <div class="api-key-container">
                    <label for="api-key">API Key (Hugging Face hoặc Replicate):</label>
                    <input type="text" id="api-key" placeholder="Nhập API key nếu bạn có, nếu không hệ thống sẽ sử dụng chế độ mô phỏng">
                    <div class="mt-2">
                        <label for="openai-api-key">OpenAI API Key (cho DALL-E):</label>
                        <input type="text" id="openai-api-key" placeholder="Nhập OpenAI API key để sử dụng DALL-E">
                    </div>
                    <div class="api-key-buttons mt-2">
                        <button id="save-key" class="btn btn-primary">Lưu Keys</button>
                        <button id="clear-keys" class="btn btn-outline ml-2">Xóa Keys</button>
                    </div>
                </div>
            </div>
            
            <div class="test-step">
                <h3><i class="fas fa-camera"></i> Bước 2: Sử Dụng Webcam</h3>
                <p>Bạn có thể chụp ảnh từ webcam để sử dụng trong ứng dụng.</p>
                <div class="webcam-container" style="display: none; text-align: center; margin-bottom: 20px;">
                    <video id="webcam" width="400" height="300" style="border: 1px solid #ccc; border-radius: 8px;"></video>
                    <canvas id="webcam-canvas" width="400" height="300" style="display: none;"></canvas>
                    <canvas id="face-grid-canvas" width="400" height="300" style="position: absolute; left: 0; top: 0; display: none;"></canvas>
                    <div style="margin-top: 10px;">
                        <button id="capture-btn" class="btn btn-primary">
                            <i class="fas fa-camera"></i> Chụp Ảnh
                        </button>
                        <button id="toggle-grid-btn" class="btn btn-outline ml-2">
                            <i class="fas fa-th"></i> Hiện/Ẩn Lưới
                        </button>
                        <button id="stop-webcam-btn" class="btn btn-outline ml-2">
                            <i class="fas fa-stop-circle"></i> Dừng Camera
                        </button>
                    </div>
                </div>
                <button id="start-webcam-btn" class="btn btn-primary">
                    <i class="fas fa-video"></i> Bật Webcam
                </button>
            </div>
            
            <div class="test-step">
                <h3><i class="fas fa-upload"></i> Bước 3: Tải Lên Hình Ảnh</h3>
                <div class="upload-container" id="upload-area">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Kéo thả hình ảnh hoặc nhấp để chọn</p>
                    <input type="file" id="image-upload" accept="image/*" style="display: none;">
                </div>
            </div>
            
            <!-- Thêm phần nhập tuổi người dùng -->
            <div class="test-step">
                <h3><i class="fas fa-birthday-cake"></i> Bước 4: Nhập Tuổi Của Bạn</h3>
                <div class="age-input-section" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                        Tuổi của bạn sẽ giúp AI mô phỏng chính xác hơn tác động của chất gây nghiện theo từng độ tuổi
                    </p>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label for="user-age" style="font-weight: 500;">Tuổi:</label>
                        <input 
                            type="number" 
                            id="user-age" 
                            min="10" 
                            max="100" 
                            value="25" 
                            style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;"
                        >
                        <span style="font-size: 14px; color: #666;">tuổi</span>
                    </div>
                    <div class="age-impact-info" style="margin-top: 15px; padding: 10px; background: rgba(0, 123, 255, 0.1); border-radius: 4px;">
                        <p style="margin: 0; font-size: 14px;">
                            <i class="fas fa-info-circle" style="color: #007bff;"></i>
                            <span id="age-impact-text">Ở độ tuổi 25, cơ thể bạn đang ở giai đoạn khỏe mạnh nhất.</span>
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="test-step">
                <h3><i class="fas fa-sliders-h"></i> Bước 5: Cấu Hình</h3>
                <div class="controls">
                    <div class="control-group">
                        <label for="effect-type">Loại Hiệu Ứng:</label>
                        <select id="effect-type">
                            <option value="drug-effects">Ma Túy</option>
                            <option value="alcohol-effects">Rượu Bia</option>
                            <option value="smoking-effects">Thuốc Lá</option>
                            <option value="age">Lão Hóa (Deep Learning)</option>
                            <option value="rejuvenate">Trẻ Hóa (Deep Learning)</option>
                            <option value="expression">Biểu Cảm (Deep Learning)</option>
                            <option value="enhance-detail">Nâng Cao Chi Tiết HD</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="years">Số Năm Sử Dụng:</label>
                        <input type="range" id="years" min="1" max="20" value="10" step="1">
                        <p id="years-display">10 năm</p>
                    </div>
                    
                    <div class="control-group">
                        <label for="method">Phương Pháp:</label>
                        <select id="method">
                           
                            <option value="replicate">Replicate API</option>
                            
                        </select>
                    </div>
                </div>
                
                <div id="effect-description" class="effect-description" style="display: none;">
                    <h4><i class="fas fa-info-circle"></i> Miêu tả Tác Hại:</h4>
                    <p id="effect-description-text"></p>
                    <p class="note"><i class="fas fa-exclamation-triangle"></i> <strong>Lưu ý:</strong> Trang phục, phụ kiện và kiểu tóc sẽ được giữ nguyên. Chỉ khuôn mặt và da sẽ thay đổi.</p>
                </div>
                
                <button id="process-btn" class="process-btn" disabled>
                    <i class="fas fa-magic"></i> Xử Lý Biến Đổi
                </button>
            </div>
        </div>
        
        <div class="status-container" id="status-container">
            <h3>Trạng Thái Xử Lý</h3>
            <p class="status-message" id="status-message">Đang chuẩn bị...</p>
            <div class="loading-bar">
                <div class="loading-progress" id="loading-progress"></div>
            </div>
        </div>
        
        <div class="result-container" id="result-container">
            <h3>Kết Quả Biến Đổi</h3>
            
            <!-- Thêm phần hiển thị báo cáo CNN -->
            <div id="cnn-report" class="cnn-report" style="display: none;">
                <h4><i class="fas fa-brain"></i> Phân Tích CNN Feature Extractor</h4>
                <div class="report-summary" id="report-summary"></div>
                <div class="report-details" id="report-details"></div>
                <div class="report-indicators" id="report-indicators"></div>
            </div>
            
            <div class="result-grid">
                <div class="result-item">
                    <div class="result-label">Hình Ảnh Gốc</div>
                    <img id="original-image" class="result-image" src="" alt="Hình ảnh gốc">
                </div>
                <div class="result-item">
                    <div class="result-label">Hình Ảnh Biến Đổi</div>
                    <img id="transformed-image" class="result-image" src="" alt="Hình ảnh biến đổi">
                </div>
            </div>
            
            <div class="mt-4">
                <button id="gemini-enhance-btn" class="btn btn-primary">
                    <i class="fas fa-magic"></i> Tối ưu bằng Gemini AI
                </button>
                <button id="download-btn" class="btn btn-primary">
                    <i class="fas fa-download"></i> Tải Xuống Kết Quả
                </button>
                <button id="reset-btn" class="btn btn-outline ml-2">
                    <i class="fas fa-redo"></i> Thử Lại
                </button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.7.4/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.1/dist/face-api.min.js"></script>
    <script src="../javaScript/face_detection.js"></script>
    <script src="../javaScript/cnn_feature_extractor.js"></script>
    <script src="../javaScript/ai_face_transformer.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const apiKeyInput = document.getElementById('api-key');
            const openaiApiKeyInput = document.getElementById('openai-api-key');
            const saveKeyBtn = document.getElementById('save-key');
            const clearKeysBtn = document.getElementById('clear-keys');
            const uploadArea = document.getElementById('upload-area');
            const imageUpload = document.getElementById('image-upload');
            const effectTypeSelect = document.getElementById('effect-type');
            const yearsInput = document.getElementById('years');
            const yearsDisplay = document.getElementById('years-display');
            const methodSelect = document.getElementById('method');
            const processBtn = document.getElementById('process-btn');
            const statusContainer = document.getElementById('status-container');
            const statusMessage = document.getElementById('status-message');
            const loadingProgress = document.getElementById('loading-progress');
            const resultContainer = document.getElementById('result-container');
            const originalImage = document.getElementById('original-image');
            const transformedImage = document.getElementById('transformed-image');
            const downloadBtn = document.getElementById('download-btn');
            const resetBtn = document.getElementById('reset-btn');
            
            // Thêm tham chiếu đến các phần tử liên quan đến tuổi
            const userAgeInput = document.getElementById('user-age');
            const ageImpactText = document.getElementById('age-impact-text');
            
            // Elements for webcam
            const startWebcamBtn = document.getElementById('start-webcam-btn');
            const stopWebcamBtn = document.getElementById('stop-webcam-btn');
            const captureBtn = document.getElementById('capture-btn');
            const toggleGridBtn = document.getElementById('toggle-grid-btn');
            const webcamContainer = document.querySelector('.webcam-container');
            const webcamElement = document.getElementById('webcam');
            const webcamCanvas = document.getElementById('webcam-canvas');
            const faceGridCanvas = document.getElementById('face-grid-canvas');
            
            // Variables
            let uploadedImage = null;
            let transformer = new AIFaceTransformer();
            let currentApiKey = localStorage.getItem('stable_diffusion_api_key') || '';
            let currentOpenAIApiKey = localStorage.getItem('openai_api_key') || '';
            let currentCNNReport = null; // Lưu báo cáo CNN hiện tại
            
            let webcamStream = null;
            let isGridVisible = false;
            let faceDetectionInterval = null;
            
            // Initialize
            if (currentApiKey) {
                apiKeyInput.value = currentApiKey;
            }
            
            if (currentOpenAIApiKey) {
                openaiApiKeyInput.value = currentOpenAIApiKey;
            }
            
            // Khởi tạo transformer với API keys
            transformer.initialize(currentApiKey, currentOpenAIApiKey);
            
            // Đặt tuổi mặc định cho transformer
            if (userAgeInput) {
                const defaultAge = parseInt(userAgeInput.value) || 25;
                transformer.setUserAge(defaultAge);
                updateAgeImpactInfo();
            }
            
            // Gọi hàm cập nhật miêu tả khi tải trang
            setTimeout(() => {
                updateEffectDescription();
            }, 100);
            
            // Event: Update years display
            yearsInput.addEventListener('input', function() {
                const effectType = effectTypeSelect.value;
                if (effectType === 'enhance-detail') {
                    yearsDisplay.textContent = `Mức độ: ${this.value}/20`;
                } else {
                    yearsDisplay.textContent = this.value + ' năm';
                }
                updateEffectDescription();
            });
            
            // Event: Update user age
            if (userAgeInput) {
                userAgeInput.addEventListener('input', function() {
                    const age = parseInt(this.value) || 25;
                    transformer.setUserAge(age);
                    updateAgeImpactInfo();
                    updateEffectDescription();
                });
            }
            
            // Cập nhật thông tin tác động theo tuổi
            function updateAgeImpactInfo() {
                if (userAgeInput && ageImpactText) {
                    const age = parseInt(userAgeInput.value) || 25;
                    const effectType = effectTypeSelect.value;
                    const ageImpactInfo = transformer.getAgeImpactInfo(effectType, age);
                    ageImpactText.textContent = ageImpactInfo;
                }
            }
            
            // Event: Change effect type
            effectTypeSelect.addEventListener('change', function() {
                updateEffectDescription();
                updateAgeImpactInfo();
            });
            
            // Event: Save API keys
            saveKeyBtn.addEventListener('click', function() {
                const apiKey = apiKeyInput.value.trim();
                const openaiApiKey = openaiApiKeyInput.value.trim();
                
                localStorage.setItem('stable_diffusion_api_key', apiKey);
                localStorage.setItem('openai_api_key', openaiApiKey);
                
                currentApiKey = apiKey;
                currentOpenAIApiKey = openaiApiKey;
                
                // Cập nhật transformer với API keys mới
                transformer.initialize(apiKey, openaiApiKey);
                
                alert('API keys đã được lưu!');
                
                // Tự động chọn phương pháp phù hợp dựa trên API key đã nhập
                if (openaiApiKey && methodSelect.value !== 'dalle') {
                    if (methodSelect.value === 'auto') {
                        // Giữ nguyên auto nếu đã chọn
                    } else if (!apiKey) {
                        // Chọn dalle nếu chỉ có OpenAI API key
                        methodSelect.value = 'dalle';
                    }
                }
            });
            
            // Event: Clear API keys
            clearKeysBtn.addEventListener('click', function() {
                apiKeyInput.value = '';
                openaiApiKeyInput.value = '';
                localStorage.removeItem('stable_diffusion_api_key');
                localStorage.removeItem('openai_api_key');
                currentApiKey = '';
                currentOpenAIApiKey = '';
                
                transformer.initialize('', '');
                transformer.fallbackToCSS = true;
                
                alert('API keys đã được xóa!');
                
                // Chuyển sang chế độ CSS nếu đang chọn phương pháp API
                if (methodSelect.value !== 'css' && methodSelect.value !== 'auto') {
                    methodSelect.value = 'css';
                }
            });
            
            // Event: Upload area click
            uploadArea.addEventListener('click', function() {
                imageUpload.click();
            });
            
            // Event: File upload
            imageUpload.addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    handleImageUpload(this.files[0]);
                }
            });
            
            // Event: Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = 'var(--primary-color)';
            });
            
            uploadArea.addEventListener('dragleave', function() {
                this.style.borderColor = 'var(--border-color)';
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = 'var(--border-color)';
                
                if (e.dataTransfer.files.length) {
                    handleImageUpload(e.dataTransfer.files[0]);
                }
            });
            
            // Event: Process button click
            processBtn.addEventListener('click', function() {
                // Reset previous results
                resultContainer.style.display = 'none';
                transformedImage.src = '';
                document.getElementById('cnn-report').style.display = 'none';
                
                // Process the image
                processImage();
            });
            
            // Event: Reset button click
            resetBtn.addEventListener('click', resetTest);
            
            // Event: Download button click
            downloadBtn.addEventListener('click', downloadResult);
            
            // Event: Method selection
            methodSelect.addEventListener('change', function() {
                const method = this.value;
                
                // Kiểm tra xem có API key phù hợp không
                if (method === 'dalle' && !currentOpenAIApiKey) {
                    alert('Bạn cần nhập OpenAI API Key để sử dụng phương pháp DALL-E.');
                    this.value = transformer.fallbackToCSS ? 'css' : 'auto';
                } else if ((method === 'huggingface' || method === 'replicate' || method === 'github') && !currentApiKey) {
                    alert('Bạn cần nhập API Key cho Hugging Face hoặc Replicate để sử dụng phương pháp này.');
                    this.value = transformer.fallbackToCSS ? 'css' : 'auto';
                }
                
                // Cập nhật giao diện dựa trên phương pháp đã chọn
                updateInterfaceForMethod(method);
                
                // Cập nhật trạng thái fallbackToCSS
                if (method === 'css') {
                    transformer.fallbackToCSS = true;
                } else if (method !== 'auto') {
                    transformer.fallbackToCSS = false;
                }
            });
            
            // Event: Effect type selection
            effectTypeSelect.addEventListener('change', function() {
                const effectType = this.value;
                
                // Tự động chọn phương pháp phù hợp cho hiệu ứng
                if (['age', 'rejuvenate', 'expression'].includes(effectType)) {
                    // Nếu chọn hiệu ứng deep learning, tự động chuyển sang phương pháp deep learning
                    if (methodSelect.value !== 'deep-learning' && methodSelect.value !== 'auto') {
                        methodSelect.value = 'deep-learning';
                        // Cập nhật giao diện theo phương pháp
                        updateInterfaceForMethod('deep-learning');
                    }
                } else if (effectType === 'enhance-detail') {
                    // Cho hiệu ứng nâng cao chi tiết, sử dụng phương pháp mặc định mà không cần thay đổi
                    // Hiển thị thanh trượt để điều chỉnh mức độ nâng cao
                    document.getElementById('years-display').textContent = `Mức độ: ${yearsInput.value}/20`;
                }
                updateEffectDescription();
            });
            
            // Hàm cập nhật miêu tả hiệu ứng
            function updateEffectDescription() {
                const effectType = effectTypeSelect.value;
                const years = parseInt(yearsInput.value);
                const userAge = userAgeInput ? parseInt(userAgeInput.value) || 25 : 25;
                
                const effectDescriptionDiv = document.getElementById('effect-description');
                const effectDescriptionText = document.getElementById('effect-description-text');
                
                if (effectType === 'enhance-detail') {
                    effectDescriptionText.innerHTML = `Tính năng nâng cao chi tiết giúp làm rõ nét các đặc điểm khuôn mặt, tăng cường độ sắc nét và tương phản. Mức độ hiện tại: <strong>${years}/20</strong>.`;
                } else {
                    // Lấy mô tả tác hại
                    const description = transformer.getEffectDescription(effectType, years);
                    
                    // Lấy mô tả chi tiết dựa trên tuổi
                    const ageDescription = transformer.getDetailedAgeDescription(effectType, years, userAge);
                    
                    // Kết hợp cả hai mô tả
                    effectDescriptionText.innerHTML = `<p>${description}</p><p><strong>Tác động với tuổi của bạn:</strong> ${ageDescription}</p>`;
                }
                
                effectDescriptionDiv.style.display = 'block';
            }
            
            // Function: Handle image upload
            function handleImageUpload(file) {
                if (!file.type.match('image.*')) {
                    alert('Vui lòng chọn một tệp hình ảnh hợp lệ.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImage = new Image();
                    uploadedImage.onload = function() {
                        originalImage.src = uploadedImage.src;
                        processBtn.disabled = false;
                        
                        // Show uploaded image in upload area
                        uploadArea.innerHTML = '<img src="' + uploadedImage.src + '" style="max-height: 150px; max-width: 100%;">';
                    };
                    uploadedImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            // Function: Process image
            async function processImage() {
                if (!uploadedImage) {
                    alert('Vui lòng tải lên hình ảnh trước khi xử lý.');
                    return;
                }
                
                // Get selected options
                const effectType = effectTypeSelect.value;
                const years = parseInt(yearsInput.value);
                const method = methodSelect.value;
                
                // Hiển thị mô tả chi tiết về tác hại nếu có thể
                if (transformer.generateDetailedDescription && 
                    ['drug-effects', 'alcohol-effects', 'smoking-effects'].includes(effectType)) {
                    const detailedDesc = transformer.generateDetailedDescription(effectType, years);
                    console.log('📋 Mô tả chi tiết tác hại:', detailedDesc.description);
                    
                    // Hiển thị mô tả trong status
                    updateStatus(`Đang chuẩn bị xử lý: ${detailedDesc.description}`, 5);
                }
                
                // Trích xuất và hiển thị CNN features nếu có
                if (transformer.cnnExtractor && transformer.featuresEnabled && 
                    ['drug-effects', 'alcohol-effects', 'smoking-effects'].includes(effectType)) {
                    updateStatus('Đang phân tích đặc trưng CNN...', 15);
                    
                    try {
                        const features = await transformer.cnnExtractor.extractFeatures(uploadedImage, effectType, years);
                        if (features) {
                            const report = transformer.cnnExtractor.generateDamageReport(features, effectType, years);
                            currentCNNReport = report;
                            displayCNNReport(report);
                        }
                    } catch (error) {
                        console.warn('Không thể trích xuất CNN features:', error);
                    }
                }
                
                // Show status container
                statusContainer.style.display = 'block';
                loadingProgress.style.width = '0%';
                updateStatus('Đang chuẩn bị xử lý...', 0);
                
                // Force method if selected
                if (method !== 'auto') {
                    transformer.fallbackToCSS = (method === 'css');
                }
                
                try {
                    // Load face detection models if needed
                    if (window.FaceDetection) {
                        updateStatus('Đang tải mô hình nhận diện khuôn mặt...', 10);
                        try {
                            await window.FaceDetection.loadModels();
                        } catch (modelError) {
                            console.warn('Không thể tải mô hình nhận diện khuôn mặt:', modelError);
                            // Tiếp tục mà không cần nhận diện khuôn mặt
                        }
                    }
                    
                    // Detect face (optional, just for testing)
                    updateStatus('Đang phân tích khuôn mặt...', 20);
                    try {
                        await window.FaceDetection.detect(uploadedImage);
                    } catch (faceError) {
                        console.warn('Không thể phát hiện khuôn mặt:', faceError);
                        // Continue even if face detection fails
                    }
                    
                    // Process transformation
                    updateStatus('Đang bắt đầu biến đổi...', 30);
                    
                    // Progress callback function
                    const progressCallback = (status, percent) => {
                        let message = 'Đang xử lý...';
                        let progressPercent = 30 + (percent * 0.7); // 30% to 100%
                        
                        switch(status) {
                            case 'preparing':
                                message = 'Đang chuẩn bị ảnh...';
                                break;
                            case 'processing':
                                if (typeof percent === 'string') {
                                    message = percent; // If percent is actually a message
                                } else {
                                    message = `Đang xử lý biến đổi... (${Math.round(percent)}%)`;
                                }
                                break;
                            case 'succeeded':
                                message = 'Hoàn thành!';
                                progressPercent = 100;
                                break;
                            case 'failed':
                                message = 'Xử lý thất bại!';
                                break;
                        }
                        
                        updateStatus(message, progressPercent);
                    };
                    
                    // Kiểm tra kết nối server trước khi thực hiện các phương thức API
                    if (method !== 'css' && !transformer.fallbackToCSS) {
                        try {
                            updateStatus('Đang kiểm tra kết nối đến server API...', 20);
                            // Sử dụng setTimeout để tránh browser blocking request quá lâu
                            const serverCheckPromise = new Promise((resolve, reject) => {
                                const timeoutId = setTimeout(() => {
                                    reject(new Error('Timeout khi kết nối đến server API'));
                                }, 5000); // Timeout sau 5 giây
                                
                                fetch('http://localhost:3004/api/ping', { method: 'GET' })
                                    .then(response => {
                                        clearTimeout(timeoutId);
                                        if (response.ok) {
                                            return response.json();
                                        } else {
                                            throw new Error(`Lỗi HTTP: ${response.status}`);
                                        }
                                    })
                                    .then(data => {
                                        console.log('Kết nối server thành công:', data);
                                        resolve(data);
                                    })
                                    .catch(error => {
                                        clearTimeout(timeoutId);
                                        reject(error);
                                    });
                            });
                            
                            await serverCheckPromise;
                        } catch (serverError) {
                            console.error('Lỗi kết nối server:', serverError);
                            if (method !== 'auto' && method !== 'css') {
                                updateStatus('Server API không khả dụng. Chuyển sang chế độ mô phỏng CSS.', 30);
                                setTimeout(() => {
                                    if (confirm('Server API không khả dụng. Bạn cần khởi động server bằng cách chạy lệnh "cd server" và sau đó "node server.js" trong cmd hoặc PowerShell hoặc thay đổi cổng server sang 3001. Bạn có muốn tiếp tục với chế độ mô phỏng CSS không?')) {
                                        transformer.fallbackToCSS = true;
                                    } else {
                                        statusContainer.style.display = 'none';
                                        return;
                                    }
                                }, 500);
                                transformer.fallbackToCSS = true;
                            } else {
                                console.warn('Server API không khả dụng, sẽ sử dụng chế độ mô phỏng CSS');
                                transformer.fallbackToCSS = true;
                            }
                        }
                    }
                    
                    // Transform the face
                    let transformedImageUrl;
                    
                    // Xử lý hiệu ứng nâng cao chi tiết HD
                    if (effectType === 'enhance-detail') {
                        updateStatus('Đang áp dụng thuật toán nâng cao chi tiết...', 40);
                        // Sử dụng mức cường độ từ giá trị years (0-20 thành 0-1)
                        const intensityLevel = years / 20;
                        transformedImageUrl = await transformer.enhanceImageDetail(uploadedImage, intensityLevel, progressCallback);
                    }
                    // Use specific method based on selection
                    else if (method === 'github') {
                        const base64Image = await transformer.imageToBase64(uploadedImage);
                        transformedImageUrl = await transformer.transformWithGitHubStableDiffusion(base64Image, effectType, years, progressCallback);
                    } else if (method === 'huggingface') {
                        const base64Image = await transformer.imageToBase64(uploadedImage);
                        transformedImageUrl = await transformer.transformWithHuggingFace(base64Image, effectType, years, progressCallback);
                    } else if (method === 'replicate') {
                        const base64Image = await transformer.imageToBase64(uploadedImage);
                        const requestId = await transformer.createTransformationRequest(base64Image, effectType, years);
                        transformedImageUrl = await transformer.waitForCompletion(requestId, progressCallback);
                    } else if (method === 'local') {
                        const base64Image = await transformer.imageToBase64(uploadedImage);
                        transformedImageUrl = await transformer.useLocalStableDiffusion(base64Image, effectType, years, progressCallback);
                    } else if (method === 'dalle') {
                        const base64Image = await transformer.imageToBase64(uploadedImage);
                        transformedImageUrl = await transformer.transformWithDallE(base64Image, effectType, years, progressCallback);
                    } else if (method === 'css') {
                        transformedImageUrl = await transformer.simulateTransformation(uploadedImage, effectType, years, progressCallback);
                    } else if (method === 'deep-learning') {
                        // Chọn phương thức deep learning phù hợp dựa trên loại hiệu ứng
                        if (effectType === 'age') {
                            transformedImageUrl = await transformer.ageFace(uploadedImage, years, progressCallback);
                        } else if (effectType === 'rejuvenate') {
                            transformedImageUrl = await transformer.rejuvenateFace(uploadedImage, years, progressCallback);
                        } else if (effectType === 'expression') {
                            // Đối với expression, sử dụng years như một chỉ số biểu cảm (0-10)
                            const expressions = ['neutral', 'happy', 'sad', 'angry', 'surprised', 'disgusted', 'fearful'];
                            const expressionIndex = Math.min(Math.floor(years / 3), expressions.length - 1);
                            transformedImageUrl = await transformer.transformFacialExpression(uploadedImage, expressions[expressionIndex], progressCallback);
                        } else {
                            // Sử dụng phương thức chung nếu không khớp
                            transformedImageUrl = await transformer.transformWithDeepLearning(uploadedImage, effectType, years/20, progressCallback);
                        }
                    } else {
                        // Auto - try all methods
                        transformedImageUrl = await transformer.transformFace(uploadedImage, effectType, years, progressCallback);
                    }
                    
                    // Log the transformed image URL for debugging
                    console.log('Transformed image URL:', transformedImageUrl);
                    
                    if (transformedImageUrl) {
                        // Display result
                        transformedImage.onload = function() {
                            resultContainer.style.display = 'block';
                            updateStatus('Hoàn thành biến đổi!', 100);
                        };
                        
                        transformedImage.onerror = function() {
                            console.error('Lỗi tải hình ảnh biến đổi:', transformedImage.src);
                            updateStatus('Lỗi tải hình ảnh biến đổi!', 0);
                            
                            // Tạo hình ảnh lỗi đơn giản để hiển thị
                            const errorCanvas = document.createElement('canvas');
                            errorCanvas.width = 400;
                            errorCanvas.height = 400;
                            const ctx = errorCanvas.getContext('2d');
                            
                            // Vẽ nền và thông báo lỗi
                            ctx.fillStyle = '#f0f0f0';
                            ctx.fillRect(0, 0, errorCanvas.width, errorCanvas.height);
                            
                            ctx.fillStyle = '#333';
                            ctx.font = '20px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText('Không thể tải hình ảnh', errorCanvas.width/2, errorCanvas.height/2 - 40);
                            ctx.fillText('Vui lòng thử lại hoặc chọn phương pháp CSS', errorCanvas.width/2, errorCanvas.height/2);
                            
                            // Hiển thị hình ảnh lỗi
                            transformedImage.src = errorCanvas.toDataURL();
                            resultContainer.style.display = 'block';
                        };
                        
                        // Set source after attaching event handlers
                        transformedImage.src = transformedImageUrl;
                    } else {
                        throw new Error('Không nhận được kết quả biến đổi');
                    }
                    
                } catch (error) {
                    console.error('Lỗi khi xử lý hình ảnh:', error);
                    updateStatus('Lỗi: ' + error.message, 0);
                    
                    // Fallback to CSS simulation if there's an error
                    try {
                        // Định nghĩa lại progressCallback trong phạm vi này để đảm bảo nó tồn tại
                        const fallbackProgressCallback = (status, percent) => {
                            let message = 'Đang xử lý...';
                            let progressPercent = 30 + (percent * 0.7); // 30% to 100%
                            
                            switch(status) {
                                case 'preparing':
                                    message = 'Đang chuẩn bị ảnh mô phỏng...';
                                    break;
                                case 'processing':
                                    if (typeof percent === 'string') {
                                        message = percent; // If percent is actually a message
                                    } else {
                                        message = `Đang xử lý mô phỏng... (${Math.round(percent)}%)`;
                                    }
                                    break;
                                case 'succeeded':
                                    message = 'Hoàn thành!';
                                    progressPercent = 100;
                                    break;
                                case 'failed':
                                    message = 'Xử lý thất bại!';
                                    break;
                            }
                            
                            updateStatus(message, progressPercent);
                        };
                        
                        updateStatus('Đang thử phương pháp mô phỏng...', 50);
                        const simUrl = await transformer.simulateTransformation(uploadedImage, effectType, years, fallbackProgressCallback);
                        if (simUrl) {
                            transformedImage.src = simUrl;
                            resultContainer.style.display = 'block';
                            updateStatus('Hoàn thành (chế độ mô phỏng)!', 100);
                        } else {
                            throw new Error('Không thể tạo hình ảnh mô phỏng');
                        }
                    } catch (simError) {
                        console.error('Lỗi khi mô phỏng:', simError);
                        
                        // Tạo một canvas đơn giản để hiển thị lỗi
                        const errorCanvas = document.createElement('canvas');
                        errorCanvas.width = 400;
                        errorCanvas.height = 400;
                        const ctx = errorCanvas.getContext('2d');
                        
                        ctx.fillStyle = '#f0f0f0';
                        ctx.fillRect(0, 0, errorCanvas.width, errorCanvas.height);
                        
                        ctx.fillStyle = '#cc0000';
                        ctx.font = 'bold 20px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('Đã xảy ra lỗi', errorCanvas.width/2, errorCanvas.height/2 - 50);
                        
                        ctx.fillStyle = '#333';
                        ctx.font = '16px Arial';
                        ctx.fillText(error.message, errorCanvas.width/2, errorCanvas.height/2 - 10);
                        ctx.fillText('Vui lòng thử lại với hình ảnh khác', errorCanvas.width/2, errorCanvas.height/2 + 30);
                        
                        // Hiển thị lỗi
                        transformedImage.src = errorCanvas.toDataURL();
                        resultContainer.style.display = 'block';
                    }
                }
            }
            
            // Function: Update status
            function updateStatus(message, percent) {
                statusMessage.textContent = message;
                loadingProgress.style.width = percent + '%';
            }
            
            // Function: Reset test
            function resetTest() {
                uploadedImage = null;
                processBtn.disabled = true;
                statusContainer.style.display = 'none';
                resultContainer.style.display = 'none';
                document.getElementById('cnn-report').style.display = 'none';
                currentCNNReport = null;
                uploadArea.innerHTML = `
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Kéo thả hình ảnh hoặc nhấp để chọn</p>
                `;
                imageUpload.value = '';
            }
            
            // Function: Download result
            function downloadResult() {
                if (!transformedImage.src) {
                    alert('Không có kết quả để tải xuống');
                    return;
                }
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set canvas size
                canvas.width = 1000;
                canvas.height = 600;
                
                // Fill background
                ctx.fillStyle = '#f8f9fa';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw title
                ctx.fillStyle = '#1a1a1a';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`Tác Động Của ${getEffectLabel()} Sau ${yearsInput.value} Năm`, canvas.width / 2, 40);
                
                // Draw images
                const imgWidth = 450;
                const imgHeight = 450;
                ctx.drawImage(originalImage, 50, 80, imgWidth, imgHeight);
                ctx.drawImage(transformedImage, 500, 80, imgWidth, imgHeight);
                
                // Draw labels
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(50, 530, imgWidth, 30);
                ctx.fillRect(500, 530, imgWidth, 30);
                
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('HIỆN TẠI', 50 + imgWidth / 2, 550);
                ctx.fillText(`SAU ${yearsInput.value} NĂM`, 500 + imgWidth / 2, 550);
                
                // Add watermark
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.font = '14px Arial';
                ctx.textAlign = 'right';
                ctx.fillText('vicongdongkhoemanh.org', canvas.width - 20, canvas.height - 10);
                
                // Create download link
                const link = document.createElement('a');
                link.download = `tac-dong-${effectTypeSelect.value}-${yearsInput.value}-nam.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.8);
                link.click();
            }
            
            // Helper: Get effect label
            function getEffectLabel() {
                const effect = effectTypeSelect.value;
                switch (effect) {
                    case 'drug-effects': return 'Ma Túy';
                    case 'alcohol-effects': return 'Rượu Bia';
                    case 'smoking-effects': return 'Thuốc Lá';
                    case 'age': return 'Lão Hóa';
                    case 'rejuvenate': return 'Trẻ Hóa';
                    case 'expression': return 'Biểu Cảm';
                    case 'enhance-detail': return 'Nâng Cao Chi Tiết HD';
                    default: return '';
                }
            }
            
            // Function: Display CNN Report
            function displayCNNReport(report) {
                if (!report) return;
                
                const reportDiv = document.getElementById('cnn-report');
                const summaryDiv = document.getElementById('report-summary');
                const detailsDiv = document.getElementById('report-details');
                const indicatorsDiv = document.getElementById('report-indicators');
                
                // Hiển thị summary
                summaryDiv.textContent = report.summary;
                
                // Hiển thị details
                detailsDiv.innerHTML = '<ul>' + 
                    report.details.map(detail => `<li>${detail}</li>`).join('') + 
                    '</ul>';
                
                // Hiển thị indicators
                indicatorsDiv.innerHTML = '';
                report.visualIndicators.forEach(indicator => {
                    const badge = document.createElement('span');
                    badge.className = 'indicator-badge';
                    
                    // Xác định màu badge dựa trên intensity
                    if (indicator.intensity > 0.7) {
                        badge.className += ' high';
                    } else if (indicator.intensity > 0.4) {
                        badge.className += ' medium';
                    } else {
                        badge.className += ' low';
                    }
                    
                    // Tạo text cho badge
                    let badgeText = '';
                    switch (indicator.type) {
                        case 'wrinkles':
                            badgeText = `Nếp nhăn (${Math.round(indicator.intensity * 100)}%)`;
                            break;
                        case 'sores':
                            badgeText = `Vết loét: ${indicator.count} vết`;
                            break;
                        case 'spider_veins':
                            badgeText = `Mạch máu nổi (${Math.round(indicator.intensity * 100)}%)`;
                            break;
                        case 'vertical_lines':
                            badgeText = `Nếp nhăn quanh miệng (${Math.round(indicator.intensity * 100)}%)`;
                            break;
                        default:
                            badgeText = `${indicator.type} (${Math.round(indicator.intensity * 100)}%)`;
                    }
                    
                    badge.textContent = badgeText;
                    indicatorsDiv.appendChild(badge);
                });
                
                // Hiển thị báo cáo
                reportDiv.style.display = 'block';
            }
            
            // Start webcam
            startWebcamBtn.addEventListener('click', async function() {
                try {
                    webcamStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: 'user'
                        } 
                    });
                    
                    webcamElement.srcObject = webcamStream;
                    await webcamElement.play();
                    
                    // Show webcam container and hide start button
                    webcamContainer.style.display = 'block';
                    startWebcamBtn.style.display = 'none';
                    
                    // Đảm bảo các model face-api.js đã được tải
                    if (window.FaceDetection && typeof window.FaceDetection.loadModels === 'function') {
                        try {
                            await window.FaceDetection.loadModels();
                            startFaceDetection();
                        } catch (err) {
                            console.error('Không thể tải mô hình nhận diện khuôn mặt:', err);
                        }
                    } else {
                        console.warn('FaceDetection không khả dụng, đang tải face-api.js...');
                        await loadFaceApiModels();
                        startFaceDetection();
                    }
                } catch (error) {
                    console.error('Lỗi khi bật webcam:', error);
                    alert('Không thể truy cập webcam. Vui lòng đảm bảo bạn đã cấp quyền truy cập camera cho trang web này.');
                }
            });
            
            // Stop webcam
            stopWebcamBtn.addEventListener('click', function() {
                stopWebcam();
                webcamContainer.style.display = 'none';
                startWebcamBtn.style.display = 'block';
            });
            
            // Capture image from webcam
            captureBtn.addEventListener('click', function() {
                if (!webcamStream) return;
                
                const ctx = webcamCanvas.getContext('2d');
                // Vẽ frame hiện tại từ video vào canvas
                ctx.drawImage(webcamElement, 0, 0, webcamCanvas.width, webcamCanvas.height);
                
                // Chuyển đổi canvas thành blob
                webcamCanvas.toBlob(function(blob) {
                    // Tạo file từ blob
                    const file = new File([blob], "webcam-capture.jpg", { type: "image/jpeg" });
                    
                    // Gọi hàm xử lý upload ảnh
                    handleImageUpload(file);
                    
                    // Dừng webcam sau khi chụp
                    stopWebcam();
                    webcamContainer.style.display = 'none';
                    startWebcamBtn.style.display = 'block';
                }, 'image/jpeg', 0.95);
            });
            
            // Toggle face grid
            toggleGridBtn.addEventListener('click', function() {
                isGridVisible = !isGridVisible;
                faceGridCanvas.style.display = isGridVisible ? 'block' : 'none';
            });
            
            // Stop webcam function
            function stopWebcam() {
                if (webcamStream) {
                    webcamStream.getTracks().forEach(track => {
                        track.stop();
                    });
                    webcamStream = null;
                    webcamElement.srcObject = null;
                }
                
                if (faceDetectionInterval) {
                    clearInterval(faceDetectionInterval);
                    faceDetectionInterval = null;
                }
                
                // Ẩn canvas lưới mặt
                faceGridCanvas.style.display = 'none';
            }
            
            // Start face detection
            function startFaceDetection() {
                // Đặt vị trí canvas lưới sao cho trùng khớp với video
                const videoRect = webcamElement.getBoundingClientRect();
                const parentRect = webcamElement.parentElement.getBoundingClientRect();
                
                faceGridCanvas.style.position = 'absolute';
                faceGridCanvas.style.left = `${videoRect.left - parentRect.left}px`;
                faceGridCanvas.style.top = `${videoRect.top - parentRect.top}px`;
                faceGridCanvas.width = webcamElement.videoWidth || 400;
                faceGridCanvas.height = webcamElement.videoHeight || 300;
                
                if (isGridVisible) {
                    faceGridCanvas.style.display = 'block';
                }
                
                // Bắt đầu vòng lặp phát hiện khuôn mặt
                faceDetectionInterval = setInterval(async () => {
                    if (!webcamStream) return;
                    
                    try {
                        const detections = await detectFaceInWebcam();
                        if (detections && isGridVisible) {
                            drawFaceGrid(detections);
                        }
                    } catch (error) {
                        console.error('Lỗi khi phát hiện khuôn mặt:', error);
                    }
                }, 100); // Phát hiện mỗi 100ms
            }
            
            // Detect face in webcam
            async function detectFaceInWebcam() {
                if (!webcamElement.videoWidth) return null;
                
                try {
                    let detections;
                    
                    // Sử dụng window.FaceDetection nếu có sẵn
                    if (window.FaceDetection && typeof window.FaceDetection.detect === 'function') {
                        const result = await window.FaceDetection.detect(webcamElement);
                        detections = result.faces || [];
                    }
                    // Hoặc sử dụng face-api.js trực tiếp
                    else if (window.faceapi) {
                        const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 });
                        detections = await faceapi.detectAllFaces(webcamElement, options)
                            .withFaceLandmarks()
                            .withFaceExpressions();
                    }
                    
                    return detections;
                } catch (error) {
                    console.error('Lỗi khi phát hiện khuôn mặt:', error);
                    return null;
                }
            }
            
            // Draw face grid
            function drawFaceGrid(detections) {
                if (!detections || detections.length === 0) return;
                
                const ctx = faceGridCanvas.getContext('2d');
                ctx.clearRect(0, 0, faceGridCanvas.width, faceGridCanvas.height);
                
                // Vẽ lưới cho mỗi khuôn mặt được phát hiện
                detections.forEach(face => {
                    let box;
                    
                    // Xử lý tùy theo định dạng phát hiện khuôn mặt
                    if (face.detection && face.detection.box) {
                        // Định dạng từ face-api.js
                        box = face.detection.box;
                    } else if (face.box) {
                        // Định dạng từ custom FaceDetection
                        box = face.box;
                    } else {
                        return;
                    }
                    
                    // Vẽ khung xung quanh khuôn mặt
                    ctx.strokeStyle = '#00ff00';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(box.x, box.y, box.width, box.height);
                    
                    // Vẽ lưới bên trong khung khuôn mặt
                    ctx.strokeStyle = 'rgba(0, 255, 0, 0.5)';
                    ctx.lineWidth = 1;
                    
                    // Số dòng và cột của lưới
                    const gridSize = 8;
                    const cellWidth = box.width / gridSize;
                    const cellHeight = box.height / gridSize;
                    
                    // Vẽ các đường ngang
                    for (let i = 1; i < gridSize; i++) {
                        ctx.beginPath();
                        ctx.moveTo(box.x, box.y + i * cellHeight);
                        ctx.lineTo(box.x + box.width, box.y + i * cellHeight);
                        ctx.stroke();
                    }
                    
                    // Vẽ các đường dọc
                    for (let i = 1; i < gridSize; i++) {
                        ctx.beginPath();
                        ctx.moveTo(box.x + i * cellWidth, box.y);
                        ctx.lineTo(box.x + i * cellWidth, box.y + box.height);
                        ctx.stroke();
                    }
                    
                    // Vẽ điểm đánh dấu các điểm đặc trưng nếu có
                    if (face.landmarks && face.landmarks.positions) {
                        ctx.fillStyle = '#ff0000';
                        face.landmarks.positions.forEach(point => {
                            ctx.beginPath();
                            ctx.arc(point.x, point.y, 2, 0, 2 * Math.PI);
                            ctx.fill();
                        });
                    }
                });
            }
            
            // Load face-api.js models manually if needed
            async function loadFaceApiModels() {
                if (!window.faceapi) {
                    console.warn('face-api.js không được tìm thấy, sử dụng phát hiện khuôn mặt đơn giản');
                    return;
                }
                
                try {
                    const modelPath = '../models';
                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri(modelPath),
                        faceapi.nets.faceLandmark68Net.loadFromUri(modelPath),
                        faceapi.nets.faceExpressionNet.loadFromUri(modelPath)
                    ]);
                    console.log('Đã tải xong các mô hình face-api.js');
                } catch (error) {
                    console.error('Lỗi khi tải mô hình face-api.js:', error);
                }
            }
            
            // Hàm cập nhật giao diện dựa trên phương pháp
            function updateInterfaceForMethod(method) {
                // Hiển thị/ẩn các tùy chọn dựa trên phương pháp
                if (method === 'deep-learning') {
                    // Hiển thị chỉ các hiệu ứng deep learning
                    const deepLearningEffects = ['age', 'rejuvenate', 'expression'];
                    Array.from(effectTypeSelect.options).forEach(option => {
                        option.style.display = deepLearningEffects.includes(option.value) ? '' : 'none';
                    });
                    
                    // Chọn hiệu ứng deep learning mặc định nếu hiệu ứng hiện tại không phải là deep learning
                    if (!deepLearningEffects.includes(effectTypeSelect.value)) {
                        effectTypeSelect.value = 'age';
                    }
                } else {
                    // Hiển thị tất cả các hiệu ứng
                    Array.from(effectTypeSelect.options).forEach(option => {
                        option.style.display = '';
                    });
                    
                    // Nếu đang chọn hiệu ứng deep learning nhưng phương pháp không phải deep learning
                    const standardEffects = ['drug-effects', 'alcohol-effects', 'smoking-effects'];
                    if (!standardEffects.includes(effectTypeSelect.value) && method !== 'auto') {
                        effectTypeSelect.value = 'drug-effects';
                    }
                }
            }
            
            // Gemini enhance button
            const geminiEnhanceBtn = document.getElementById('gemini-enhance-btn');
            geminiEnhanceBtn.addEventListener('click', enhanceWithGemini);
            
            // Kiểm tra kết nối tới server khi trang được tải
            window.addEventListener('load', async function() {
                try {
                    const response = await fetch('http://localhost:3004/api/ping', { 
                        method: 'GET',
                        timeout: 2000
                    });
                    
                    if (response.ok) {
                        console.log('Kết nối thành công tới server API');
                        // Server đang hoạt động, không cần thông báo
                    } else {
                        console.warn('Server API không phản hồi đúng');
                        geminiEnhanceBtn.dataset.warning = 'true';
                        geminiEnhanceBtn.setAttribute('title', 'Vui lòng đảm bảo server API đang chạy trước khi sử dụng tính năng này');
                        geminiEnhanceBtn.innerHTML += ' <span style="color:#ff9800;font-size:80%">(⚠️ Kiểm tra server)</span>';
                    }
                } catch (error) {
                    console.error('Không thể kết nối tới server API:', error);
                    geminiEnhanceBtn.dataset.warning = 'true';
                    geminiEnhanceBtn.setAttribute('title', 'Vui lòng chạy server API bằng lệnh "npm start" trong thư mục server');
                    geminiEnhanceBtn.innerHTML += ' <span style="color:#f44336;font-size:80%">(⚠️ Server chưa khởi động)</span>';
                }
            });
            
            // Xử lý nâng cao ảnh với Gemini
            async function enhanceWithGemini() {
                if (!transformedImage.src || transformedImage.src.trim() === '') {
                    alert('Chưa có hình ảnh để tối ưu. Vui lòng tạo hình ảnh trước.');
                    return;
                }
                
                // Khóa nút trong quá trình xử lý
                geminiEnhanceBtn.disabled = true;
                
                // Hiển thị trạng thái xử lý
                const processingDiv = document.createElement('div');
                processingDiv.className = 'gemini-processing';
                processingDiv.innerHTML = `
                    <div class="spinner"></div>
                    <span>Đang xử lý ảnh với Gemini AI...</span>
                `;
                resultContainer.insertBefore(processingDiv, resultContainer.querySelector('.mt-4'));
                processingDiv.style.display = 'block';
                
                try {
                    // Lấy base64 của ảnh đã biến đổi (giữ nguyên)
                    const imageData = transformedImage.src; // Sử dụng trực tiếp URL hoặc data URL
                    
                    // Lấy loại hiệu ứng và năm hiện tại
                    const effectType = effectTypeSelect.value;
                    const years = parseInt(yearsInput.value);
                    
                    // Chuẩn bị prompt cho Gemini
                    const geminiPrompt = `Enhance this image to make it more realistic. This shows a Vietnamese person after ${years} years of ${getEffectLabel()} use/effects. Make the facial changes more natural and realistic while maintaining the same identity. Don't change clothing or background, only enhance facial features.`;
                    
                    console.log('Đang gửi yêu cầu đến Server API...');
                    
                    // Sử dụng server API mới thay vì gọi trực tiếp Gemini API
                    const apiUrl = 'http://localhost:3004/api/gemini/enhance-image';
                    
                    // Thêm timeout cho fetch
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 giây timeout
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            image: imageData,
                            prompt: geminiPrompt,
                            apiKey: 'AIzaSyCv69A6TORLnYRhqhtGcT4vmSVkhItGjEo' // API key cho Gemini
                        }),
                        signal: controller.signal
                    }).catch(error => {
                        if (error.name === 'AbortError') {
                            throw new Error('Yêu cầu quá thời gian (30 giây). Server có thể đang quá tải hoặc không phản hồi.');
                        }
                        throw error;
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        let errorText = '';
                        try {
                            const errorData = await response.json();
                            errorText = errorData.error || errorData.message || `HTTP Error: ${response.status}`;
                        } catch (e) {
                            errorText = await response.text();
                            if (!errorText) errorText = `HTTP Error: ${response.status}`;
                        }
                        throw new Error(errorText);
                    }
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.error || 'Lỗi không xác định từ server');
                    }
                    
                    // Kiểm tra kết quả từ Gemini
                    if (result.output) {
                        // Cập nhật hình ảnh hiển thị với kết quả từ server
                        transformedImage.src = result.output;
                        
                        // Hiển thị thông báo thành công
                        processingDiv.innerHTML = `
                            <i class="fas fa-check-circle" style="color: green; margin-right: 8px;"></i>
                            <span>Nhận phân tích từ Gemini thành công!</span>
                        `;
                        
                        // Hiển thị phân tích từ Gemini nếu có
                        if (result.analysis) {
                            const analysisDiv = document.createElement('div');
                            analysisDiv.className = 'gemini-analysis mt-3';
                            analysisDiv.innerHTML = `
                                <details>
                                    <summary>Phân tích từ Gemini</summary>
                                    <div class="analysis-content p-2 mt-2 border rounded bg-light">
                                        <small>${result.analysis.replace(/\n/g, '<br>')}</small>
                                    </div>
                                </details>
                            `;
                            resultContainer.appendChild(analysisDiv);
                        }
                        
                        // Ẩn thông báo sau 3 giây
                        setTimeout(() => {
                            processingDiv.style.display = 'none';
                        }, 3000);
                    } else {
                        // Không có output image, hiển thị thông báo và giữ hình ảnh hiện tại
                        processingDiv.innerHTML = `
                            <i class="fas fa-info-circle" style="color: blue; margin-right: 8px;"></i>
                            <span>Gemini đã phân tích hình ảnh nhưng không tạo hình ảnh mới. Giữ nguyên hình ảnh hiện tại.</span>
                        `;
                        
                        setTimeout(() => {
                            processingDiv.style.display = 'none';
                        }, 3000);
                    }
                } catch (error) {
                    console.error('Lỗi khi sử dụng Gemini API:', error);
                    processingDiv.innerHTML = `
                        <i class="fas fa-exclamation-circle" style="color: red; margin-right: 8px;"></i>
                        <span>Lỗi: ${error.message || 'Không thể tối ưu hình ảnh'}</span>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="window.location.reload()">Tải lại trang</button>
                            <button class="btn btn-sm btn-outline-primary ml-2" onclick="checkServerStatus()">Kiểm tra server</button>
                        </div>
                    `;
                    
                    // Thêm hàm kiểm tra server status vào trang
                    window.checkServerStatus = async function() {
                        try {
                            processingDiv.innerHTML = `
                                <div class="spinner"></div>
                                <span>Đang kiểm tra trạng thái server...</span>
                            `;
                            
                            const serverCheck = await fetch('http://localhost:3004/api/ping', {
                                method: 'GET',
                                timeout: 5000
                            });
                            
                            if (serverCheck.ok) {
                                processingDiv.innerHTML = `
                                    <i class="fas fa-check-circle" style="color: green; margin-right: 8px;"></i>
                                    <span>Server đang hoạt động. Vui lòng thử lại.</span>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-success" onclick="enhanceWithGemini()">Thử lại</button>
                                    </div>
                                `;
                            } else {
                                processingDiv.innerHTML = `
                                    <i class="fas fa-exclamation-triangle" style="color: orange; margin-right: 8px;"></i>
                                    <span>Server đang hoạt động nhưng có vấn đề. Status: ${serverCheck.status}</span>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="window.location.reload()">Tải lại trang</button>
                                    </div>
                                `;
                            }
                        } catch (err) {
                            processingDiv.innerHTML = `
                                <i class="fas fa-times-circle" style="color: red; margin-right: 8px;"></i>
                                <span>Server không phản hồi hoặc chưa khởi động. Vui lòng khởi động server và thử lại.</span>
                                <div class="mt-2">
                                    <small class="text-muted d-block mb-1">Mở terminal và chạy:</small>
                                    <code class="bg-dark text-white p-1 rounded">cd server && node server.js</code>
                                </div>
                            `;
                        }
                    };
                } finally {
                    // Mở khóa nút
                    geminiEnhanceBtn.disabled = false;
                }
            }
        });
    </script>
</body>
</html> 